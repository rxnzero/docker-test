<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="ResponseTimeTopTen">
  
  <statement id="findRequestTime2Second" parameterClass="java.util.HashMap" resultClass="com.eactive.eai.rms.onl.statistics.etc.vo.ResponseTimeTopTenVO"><![CDATA[
        SELECT A.*, COALESCE(B.EAISVCDESC, 'UNKNOWN') AS EAISVCDESC
        FROM (
        SELECT @NO := @NO + 1 AS ROWNO, A.* FROM (
            SELECT
                A.EAIBZWKDSTCD,
                A.EAISVCNAME,
                COUNT(*) AS SLOWTOTALCOUNT,
                SUM(CASE WHEN 
			                TIME_TO_SEC(
			                	TIMEDIFF(
			                		STR_TO_DATE(D.MSGPRCSSYMS, '%Y%m%d%H%i%s%f'), 
			                		STR_TO_DATE(A.MSGDPSTYMS, '%Y%m%d%H%i%s%f')
			                )) >= 2.000 THEN 1
                     ELSE 0
                     END) AS SLOWCOUNT
            FROM $schemaId$.$tableName$   A
	           , $schemaId$.$tableName$   B
	           , $schemaId$.$tableName$   C
               , $schemaId$.$tableName$   D
            WHERE
                    A.EAISVCSERNO = B.EAISVCSERNO
                AND A.EAISVCSERNO = C.EAISVCSERNO
                AND A.EAISVCSERNO = D.EAISVCSERNO
                AND A.LOGPRCSSSERNO = 100
                AND B.LOGPRCSSSERNO = 200
                AND C.LOGPRCSSSERNO = 300
                AND D.LOGPRCSSSERNO = 400
                AND A.MSGDPSTYMS >= CONCAT( #msgDpstYMS#  , '00000000000' )
                AND A.MSGDPSTYMS <= CONCAT( #msgDpstYMS#  , '99999999999' )
                AND A.LOGPRCSSSERNO != 900
                AND SUBSTR(A.SVCMOTIVUSEDSTCD, 1, 1) = 'S'
                AND SUBSTR(A.PSVINTFACDSTICNAME, 1, 1) = 'S'
            GROUP BY
                A.EAIBZWKDSTCD,
                A.EAISVCNAME
            ORDER BY SLOWCOUNT DESC
        ) A,  (SELECT @NO := 0) R
        WHERE ROWNO <= 10
            AND SLOWCOUNT > 0
        ) A LEFT OUTER JOIN $schemaId$.TSEAIHE01 B
        ON  A.EAISVCNAME = B.EAISVCNAME
		]]>
  </statement>
</sqlMap>
